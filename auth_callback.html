<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Confirmation ‚Äî Au Format</title>
  
  <link rel="icon" href="/sources/img/logo_tmp.png" type="image/png">
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/config.js"></script>

 
</head>

<body>
  <div class="callback-container">
    <!-- √âtat de chargement -->
    <div id="loading">
      <div class="spinner"></div>
      <h1>V√©rification en cours...</h1>
      <p>Veuillez patienter pendant que nous confirmons votre compte.</p>
    </div>

    <!-- Message de succ√®s -->
    <div id="message">
      <div id="icon"></div>
      <h1 id="title"></h1>
      <p id="description"></p>
      <a href="/profile.html" class="btn" id="cta-btn">Acc√©der √† mon compte</a>
      <div class="countdown" id="countdown"></div>
    </div>
  </div>

  <script>
    (async function handleAuthCallback() {
      try {
        // R√©cup√©rer les param√®tres de l'URL
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const type = hashParams.get('type');
        const error = hashParams.get('error');
        const errorDescription = hashParams.get('error_description');

        // Si erreur dans l'URL
        if (error) {
          showMessage(
            'error',
            '‚ùå',
            'Erreur de confirmation',
            errorDescription || 'Une erreur est survenue lors de la confirmation de votre compte.',
            '/register.html',
            'Cr√©er un nouveau compte'
          );
          return;
        }

        // Si pas de token
        if (!accessToken) {
          showMessage(
            'error',
            '‚ö†Ô∏è',
            'Lien invalide',
            'Le lien de confirmation est invalide ou a expir√©. Veuillez vous inscrire √† nouveau.',
            '/register.html',
            'Cr√©er un compte'
          );
          return;
        }

        // V√©rifier le type d'action
        if (type === 'signup') {
          // Confirmation d'inscription
          const { data: { user }, error: userError } = await supabaseClient.auth.getUser(accessToken);

          if (userError || !user) {
            throw new Error('Impossible de r√©cup√©rer les informations utilisateur');
          }

          // Succ√®s !
          showMessage(
            'success',
            '‚úÖ',
            'Compte confirm√© avec succ√®s !',
            `Bienvenue ${user.user_metadata?.full_name || user.email} ! Votre compte a √©t√© activ√©. Vous allez √™tre redirig√© vers votre profil.`,
            '/profile.html',
            'Acc√©der √† mon compte'
          );

          // Redirection automatique apr√®s 3 secondes
          startCountdown(3);

        } else if (type === 'recovery') {
          // R√©initialisation de mot de passe
          showMessage(
            'success',
            'üîê',
            'R√©initialisation du mot de passe',
            'Vous allez √™tre redirig√© vers la page de changement de mot de passe.',
            '/reset-password.html',
            'Changer le mot de passe'
          );

          startCountdown(2);

        } else {
          // Type inconnu - rediriger vers login
          showMessage(
            'success',
            '‚úÖ',
            'Authentification r√©ussie',
            'Vous allez √™tre redirig√© vers votre espace.',
            '/profile.html',
            'Continuer'
          );

          startCountdown(2);
        }

      } catch (error) {
        console.error('Erreur callback auth:', error);
        
        showMessage(
          'error',
          '‚ùå',
          'Erreur inattendue',
          'Une erreur est survenue. Veuillez r√©essayer ou contacter le support.',
          '/login.html',
          'Retour √† la connexion'
        );
      }
    })();

    function showMessage(type, icon, title, description, href, btnText) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('message').style.display = 'block';

      document.getElementById('icon').innerHTML = `<div class="${type}-icon">${icon}</div>`;
      document.getElementById('title').textContent = title;
      document.getElementById('description').textContent = description;
      
      const btn = document.getElementById('cta-btn');
      btn.href = href;
      btn.textContent = btnText;
    }

    function startCountdown(seconds) {
      const countdownEl = document.getElementById('countdown');
      const btn = document.getElementById('cta-btn');
      let remaining = seconds;

      const updateCountdown = () => {
        if (remaining > 0) {
          countdownEl.textContent = `Redirection automatique dans ${remaining} seconde${remaining > 1 ? 's' : ''}...`;
          remaining--;
          setTimeout(updateCountdown, 1000);
        } else {
          window.location.href = btn.href;
        }
      };

      updateCountdown();
    }
  </script>
</body>
</html>