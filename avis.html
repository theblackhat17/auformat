<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Avis Clients ‚Äî Au Format</title>
  <meta name="description" content="D√©couvrez les avis v√©rifi√©s de nos clients sur nos r√©alisations en menuiserie et agencements sur mesure.">
  <link rel="canonical" href="https://auformat.fr/avis.html">

  <meta property="og:title" content="Avis Clients ‚Äî Au Format">
  <meta property="og:description" content="Ils nous font confiance.">
  <meta property="og:url" content="https://auformat.fr/avis.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#2C5F2D">

  <link rel="stylesheet" href="/sources/css/style_global.css">
  <link rel="stylesheet" href="/sources/css/style_avis.css">
  <link rel="stylesheet" href="/sources/css/style_header.css">

  <link rel="icon" href="/sources/img/logo_tmp.png" type="image/png">
  <link rel="apple-touch-icon" href="/sources/img/logo_tmp.png">

<!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Scripts d'authentification dans l'ordre -->
  <script defer src="/js/config.js"></script>
  <script defer src="/js/auth.js"></script>
  <script defer src="/js/header-auth.js"></script>
  <script defer src="/js/header.js"></script>
  
  <!-- Script pour charger les partials -->
  <script defer src="/js/include.js"></script>
</head>

<body>
    <!-- Header -->
    <div data-include="partials/header.html"></div>

    <!-- Hero Section -->
    <section class="page-hero">
        <div>
            <h1>Avis Clients</h1>
            <p>La satisfaction de nos clients est notre plus belle r√©compense</p>
        </div>
    </section>

    <!-- Stats Section (DYNAMIQUE depuis CMS) -->
    <section class="stats-section">
        <div class="stats-container">
            <div class="stats-grid" id="avis-stats">
                <!-- Les statistiques seront calcul√©es dynamiquement -->
                <div class="stat-box">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-number" data-stat="average">5.0/5</div>
                    <div class="stat-label">Note Moyenne</div>
                    <div class="stat-sublabel">Sur <span data-stat="total">0</span> avis</div>
                </div>

                <div class="stat-box">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-number" data-stat="verified">0</div>
                    <div class="stat-label">Avis V√©rifi√©s</div>
                    <div class="stat-sublabel">T√©moignages authentiques</div>
                </div>

                <div class="stat-box">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number" data-stat="particuliers">0</div>
                    <div class="stat-label">Particuliers</div>
                    <div class="stat-sublabel">Clients satisfaits</div>
                </div>

                <div class="stat-box">
                    <div class="stat-icon">üè¢</div>
                    <div class="stat-number" data-stat="professionnels">0</div>
                    <div class="stat-label">Professionnels</div>
                    <div class="stat-sublabel">Entreprises partenaires</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Filtres (DYNAMIQUE - g√©n√©r√©s selon les types de projets disponibles) -->
    <section class="filter-section">
        <div class="filter-container" id="avis-filters">
            <button class="filter-btn active" data-filter="tous">Tous les avis</button>
            <!-- Les autres filtres seront g√©n√©r√©s dynamiquement -->
        </div>
    </section>

    <!-- Avis Section (DYNAMIQUE depuis CMS) -->
    <section class="avis-section">
        <h2 class="section-title">Ce Que Disent Nos Clients</h2>
        <p class="section-subtitle">T√©moignages authentiques et v√©rifi√©s</p>

        <div class="avis-grid" id="avis-grid">
            <!-- Les avis seront charg√©s dynamiquement depuis Netlify CMS -->
            <div class="loading" style="grid-column: 1/-1; text-align: center; padding: 4rem;">
                <p>Chargement des avis...</p>
            </div>
        </div>
    </section>

    <!-- T√©moignages Vid√©o (STATIQUE - optionnel pour l'instant) -->
    <section class="video-section" style="display: none;">
        <div class="video-container">
            <h2 class="section-title">T√©moignages Vid√©o</h2>
            <p class="section-subtitle">Nos clients partagent leur exp√©rience</p>

            <div class="video-grid">
                <div class="video-card">
                    <div class="video-thumbnail">
                        <div class="play-button">‚ñ∂</div>
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">Cuisine compl√®te</h3>
                        <p class="video-description">Marie nous raconte son exp√©rience et nous fait d√©couvrir sa cuisine sur-mesure en ch√™ne massif.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
        <h2>Vous Aussi, Rejoignez Nos Clients Satisfaits</h2>
        <p>Confiez-nous votre projet et vivez l'exp√©rience Au Format</p>
        <a href="contact.html" class="btn btn-white">Demander un devis gratuit</a>
    </section>

    <div data-include="partials/footer.html"></div>

    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- Script pour charger le contenu depuis le CMS -->
    <script src="js/load-content.js"></script>

    <!-- Script pour inclure header/footer -->
    <script src="js/include.js" defer></script>

    <!-- Script principal pour charger et afficher les avis -->
    <script>
        let allAvis = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadAllAvisPage();
        });

        // Fonction pour charger tous les avis
        async function loadAllAvisPage() {
            try {
                const response = await fetch('/api/avis.json');
                const avis = await response.json();

                const container = document.getElementById('avis-grid');
                if (!container) return;

                // Trier par date (plus r√©cent en premier)
                avis.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Filtrer uniquement les avis publi√©s
                const published = avis.filter(a => a.published !== false);
                allAvis = published;

                // Afficher les avis
                displayAvis(published);

                // Cr√©er les filtres dynamiques
                createAvisFilters(published);

                // Calculer et afficher les statistiques
                displayAvisStatistics(published);

                // R√©initialiser les animations
                initAnimations();

            } catch (error) {
                console.error('Erreur lors du chargement des avis:', error);
                const container = document.getElementById('avis-grid');
                if (container) {
                    container.innerHTML = `
                        <div class="error-message" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                            <p>‚ùå Impossible de charger les avis pour le moment.</p>
                            <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.7;">
                                V√©rifiez que le fichier /api/avis.json existe.
                            </p>
                        </div>
                    `;
                }
            }
        }

        // Afficher les avis dans la grille
        function displayAvis(avisList) {
            const container = document.getElementById('avis-grid');
            
            container.innerHTML = avisList.map(avisItem => {
                const stars = '‚òÖ'.repeat(avisItem.rating || 5) + '‚òÜ'.repeat(5 - (avisItem.rating || 5));
                const projectType = avisItem.projectType || 'Autre';
                const verified = avisItem.verified ? '<span class="verified-badge">‚úì V√©rifi√©</span>' : '';
                const clientType = avisItem.clientType || 'Particulier';
                
                return `
                    <div class="avis-card" data-category="${projectType.toLowerCase()}">
                        <span class="quote-icon">"</span>
                        <div class="avis-header">
                            <div class="avis-author">
                                <div class="author-name">
                                    ${avisItem.name}
                                    ${verified}
                                </div>
                                <div class="author-info">${avisItem.location} ‚Ä¢ ${clientType}</div>
                            </div>
                            <div class="avis-rating">
                                <span class="stars">${stars}</span>
                            </div>
                        </div>
                        <span class="avis-project">${projectType}</span>
                        <p class="avis-text">${avisItem.testimonial}</p>
                        <div class="avis-date">${formatDate(avisItem.date)}</div>
                    </div>
                `;
            }).join('');
        }

        // Cr√©er les filtres dynamiques selon les types de projets
        function createAvisFilters(avisList) {
            const filterContainer = document.getElementById('avis-filters');
            if (!filterContainer) return;

            // Obtenir les types de projets uniques
            const projectTypes = [...new Set(avisList.map(a => a.projectType))].filter(Boolean);

            // Mapper les types aux cat√©gories pour correspondre aux data-category
            const typeToCategory = {
                'Cuisine': 'cuisine',
                'Dressing': 'dressing',
                'Biblioth√®que': 'biblioth√®que',
                'Commerce': 'commerce',
                'Escalier': 'escalier',
                'Autre': 'autre'
            };

            filterContainer.innerHTML = `
                <button class="filter-btn active" data-filter="tous">Tous les avis</button>
                ${projectTypes.map(type => `
                    <button class="filter-btn" data-filter="${typeToCategory[type] || type.toLowerCase()}">
                        ${type}
                    </button>
                `).join('')}
            `;

            // Ajouter les √©v√©nements aux filtres
            setupFilterButtons();
        }

        // Configurer les boutons de filtre
        function setupFilterButtons() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            const avisCards = document.querySelectorAll('.avis-card');

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Retirer la classe active de tous les boutons
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;

                    avisCards.forEach(card => {
                        const cardCategory = card.dataset.category;
                        if (filter === 'tous' || cardCategory === filter || cardCategory.includes(filter)) {
                            card.style.display = 'block';
                            setTimeout(() => {
                                card.style.opacity = '1';
                                card.style.transform = 'translateY(0)';
                            }, 10);
                        } else {
                            card.style.opacity = '0';
                            card.style.transform = 'translateY(20px)';
                            setTimeout(() => {
                                card.style.display = 'none';
                            }, 300);
                        }
                    });
                });
            });
        }

        // Calculer et afficher les statistiques
        function displayAvisStatistics(avisList) {
            const totalAvis = avisList.length;
            const averageRating = (avisList.reduce((sum, a) => sum + (a.rating || 5), 0) / totalAvis).toFixed(1);
            const verifiedCount = avisList.filter(a => a.verified).length;
            const particuliersCount = avisList.filter(a => a.clientType === 'Particulier').length;
            const professionnelsCount = avisList.filter(a => a.clientType === 'Professionnel').length;

            // Mettre √† jour les statistiques
            document.querySelector('[data-stat="average"]').textContent = averageRating + '/5';
            document.querySelector('[data-stat="total"]').textContent = totalAvis;
            document.querySelector('[data-stat="verified"]').textContent = verifiedCount;
            document.querySelector('[data-stat="particuliers"]').textContent = particuliersCount;
            document.querySelector('[data-stat="professionnels"]').textContent = professionnelsCount;
        }

        // Formater la date
        function formatDate(dateString) {
            if (!dateString) return 'R√©cemment';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 7) return 'Il y a quelques jours';
            if (diffDays < 30) return `Il y a ${Math.floor(diffDays / 7)} semaine${Math.floor(diffDays / 7) > 1 ? 's' : ''}`;
            if (diffDays < 365) return `Il y a ${Math.floor(diffDays / 30)} mois`;
            return `Il y a ${Math.floor(diffDays / 365)} an${Math.floor(diffDays / 365) > 1 ? 's' : ''}`;
        }

        // Initialiser les animations
        function initAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            // Observer pour les cartes d'avis
            const avisCards = document.querySelectorAll('.avis-card');
            avisCards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                card.style.transition = `opacity 0.5s ease ${index * 0.05}s, transform 0.5s ease ${index * 0.05}s`;
                observer.observe(card);
            });

            // Observer pour les stats
            const statBoxes = document.querySelectorAll('.stat-box');
            statBoxes.forEach((box, index) => {
                box.style.opacity = '0';
                box.style.transform = 'scale(0.8)';
                box.style.transition = `opacity 0.5s ease ${index * 0.1}s, transform 0.5s ease ${index * 0.1}s`;
                observer.observe(box);
            });

            // Animation des nombres dans les stats
            const statsObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const statNumbers = entry.target.querySelectorAll('.stat-number, [data-stat]');
                        statNumbers.forEach(statNumber => {
                            const text = statNumber.textContent;
                            if (text && !isNaN(parseInt(text))) {
                                animateNumber(statNumber, parseInt(text));
                            }
                        });
                        statsObserver.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.5 });

            const statsGrid = document.getElementById('avis-stats');
            if (statsGrid) statsObserver.observe(statsGrid);
        }

        // Animer un nombre
        function animateNumber(element, target) {
            const duration = 1500;
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = target;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        // Gestion Netlify Identity
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>

    <!-- Fallback si JS d√©sactiv√© -->
    <noscript>
        <div style="padding: 2rem; text-align: center; background: #f5f1e8;">
            <p>Activez JavaScript pour afficher les avis clients.</p>
        </div>
    </noscript>
</body>
</html>