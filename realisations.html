<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nos R√©alisations - Au Format</title>
    <link rel="stylesheet" href="sources/css/style_realisations.css">
    <link rel="stylesheet" href="sources/css/style_global.css">
    <link rel="icon" href="sources/img/logo_tmp.png">
</head>
<body>
    <!-- Header -->
    <div data-include="partials/header.html"></div>

    <!-- Hero Section -->
    <section class="page-hero">
        <div>
            <h1>Nos R√©alisations</h1>
            <p>D√©couvrez nos projets sur-mesure en menuiserie et agencement</p>
        </div>
    </section>

    <!-- Filtres (g√©n√©r√©s dynamiquement) -->
    <section class="filters-section">
        <div class="filters-container">
            <span class="filter-label">Cat√©gories :</span>
            <div id="category-filters">
                <!-- Les filtres seront g√©n√©r√©s automatiquement selon les cat√©gories disponibles -->
                <button class="filter-btn active" data-category="all">Tous les projets</button>
            </div>
        </div>
    </section>

    <!-- Portfolio (CONTENU DYNAMIQUE depuis CMS) -->
    <section class="portfolio-section">
        <!-- Les r√©alisations seront charg√©es dynamiquement ici -->
        <div class="portfolio-grid" id="realisations-grid">
            <div class="loading" style="grid-column: 1/-1; text-align: center; padding: 4rem;">
                <p>Chargement des r√©alisations...</p>
            </div>
        </div>
    </section>

    <!-- Modal pour afficher les d√©tails -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">√ó</button>
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-body">
                <span class="modal-category" id="modalCategory"></span>
                <h2 class="modal-title" id="modalTitle"></h2>
                
                <div class="modal-details">
                    <div class="detail-item" id="modal-duration-container">
                        <div class="detail-label">Dur√©e</div>
                        <div class="detail-value" id="modalDuration"></div>
                    </div>
                    <div class="detail-item" id="modal-surface-container">
                        <div class="detail-label">Surface</div>
                        <div class="detail-value" id="modalSurface"></div>
                    </div>
                    <div class="detail-item" id="modal-material-container">
                        <div class="detail-label">Mat√©riau</div>
                        <div class="detail-value" id="modalMaterial"></div>
                    </div>
                    <div class="detail-item" id="modal-location-container">
                        <div class="detail-label">Localisation</div>
                        <div class="detail-value" id="modalLocation"></div>
                    </div>
                </div>

                <p class="modal-description" id="modalDescription"></p>

                <div class="modal-features" id="modal-features-container">
                    <h3>Caract√©ristiques du projet</h3>
                    <ul class="features-list" id="modalFeatures"></ul>
                </div>

                <div class="modal-gallery" id="modalGallery">
                    <!-- Galerie d'images suppl√©mentaires si disponibles -->
                </div>
            </div>
        </div>
    </div>

    <!-- CTA Section -->
    <section class="cta-section">
        <h2>Un Projet en T√™te ?</h2>
        <p>Contactez-nous pour transformer vos id√©es en r√©alit√©</p>
        <a href="contact.html" class="btn">Demander un devis gratuit</a>
    </section>

    <div data-include="partials/footer.html"></div>

    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- Script pour charger le contenu depuis le CMS -->
    <script src="js/load-content.js"></script>

    <!-- Script pour inclure header/footer -->
    <script src="js/include.js" defer></script>

    <!-- Script pour g√©rer les r√©alisations et la modal -->
    <script>
        let currentRealisations = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Charger toutes les r√©alisations depuis le CMS
            loadRealisationsPage();
            
            // G√©rer la modal
            setupModal();
        });

        // Fonction pour charger et afficher toutes les r√©alisations
        async function loadRealisationsPage() {
            try {
                const response = await fetch('/api/realisations.json');
                const realisations = await response.json();

                const container = document.getElementById('realisations-grid');
                if (!container) return;

                // Trier par date (plus r√©cent en premier)
                realisations.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Filtrer uniquement les r√©alisations publi√©es
                const published = realisations.filter(r => r.published !== false);
                currentRealisations = published;

                // G√©n√©rer le HTML pour toutes les r√©alisations
                container.innerHTML = published.map((realisation, index) => `
                    <div class="realisation-card" data-category="${realisation.category}" data-index="${index}">
                        <img src="${realisation.image}" 
                             alt="${realisation.title}" 
                             class="realisation-img"
                             loading="lazy">
                        <div class="realisation-info">
                            <span class="category-tag">${getCategoryLabel(realisation.category)}</span>
                            <h3>${realisation.title}</h3>
                            <p>${realisation.description}</p>
                            <div class="realisation-meta">
                                ${realisation.duration ? `<span>‚è±Ô∏è ${realisation.duration}</span>` : ''}
                                ${realisation.material ? `<span>üå≥ ${realisation.material}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                // Cr√©er les filtres par cat√©gorie
                createCategoryFilters(published);

                // Ajouter les √©v√©nements de clic pour ouvrir la modal
                setupRealisationCards();

            } catch (error) {
                console.error('Erreur lors du chargement des r√©alisations:', error);
                const container = document.getElementById('realisations-grid');
                if (container) {
                    container.innerHTML = `
                        <div class="error-message" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                            <p>‚ùå Erreur lors du chargement des r√©alisations.</p>
                            <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.7;">
                                V√©rifiez que le fichier /api/realisations.json existe et que le build s'est bien ex√©cut√©.
                            </p>
                        </div>
                    `;
                }
            }
        }

        // Obtenir le label de cat√©gorie en fran√ßais
        function getCategoryLabel(category) {
            const labels = {
                'cuisines': 'üç≥ Cuisines',
                'dressings': 'üëî Dressings',
                'bibliotheques': 'üìö Biblioth√®ques',
                'commerces': 'üè¢ Commerces',
                'escaliers': 'ü™ú Escaliers',
                'exterieurs': 'üö™ Ext√©rieurs'
            };
            return labels[category] || category;
        }

        // Cr√©er les filtres de cat√©gories
        function createCategoryFilters(realisations) {
            const filterContainer = document.getElementById('category-filters');
            if (!filterContainer) return;

            // Obtenir les cat√©gories uniques pr√©sentes dans les r√©alisations
            const categories = [...new Set(realisations.map(r => r.category))];

            filterContainer.innerHTML = `
                <button class="filter-btn active" data-category="all">Tous les projets</button>
                ${categories.map(cat => `
                    <button class="filter-btn" data-category="${cat}">
                        ${getCategoryLabel(cat)}
                    </button>
                `).join('')}
            `;

            // Ajouter les √©v√©nements de filtrage
            filterContainer.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Retirer la classe active de tous les boutons
                    filterContainer.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Filtrer les r√©alisations
                    const category = btn.dataset.category;
                    const cards = document.querySelectorAll('.realisation-card');
                    
                    cards.forEach(card => {
                        if (category === 'all' || card.dataset.category === category) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });
        }

        // Configurer les √©v√©nements de clic sur les cartes
        function setupRealisationCards() {
            const cards = document.querySelectorAll('.realisation-card');
            cards.forEach(card => {
                card.addEventListener('click', () => {
                    const index = parseInt(card.dataset.index);
                    openModal(currentRealisations[index]);
                });
                card.style.cursor = 'pointer';
            });
        }

        // Ouvrir la modal avec les d√©tails d'une r√©alisation
        function openModal(realisation) {
            const modal = document.getElementById('modal');
            
            // Remplir les informations
            document.getElementById('modalImage').src = realisation.image;
            document.getElementById('modalImage').alt = realisation.title;
            document.getElementById('modalCategory').textContent = getCategoryLabel(realisation.category);
            document.getElementById('modalTitle').textContent = realisation.title;
            document.getElementById('modalDescription').textContent = realisation.body || realisation.description;

            // D√©tails optionnels
            const durationContainer = document.getElementById('modal-duration-container');
            if (realisation.duration) {
                document.getElementById('modalDuration').textContent = realisation.duration;
                durationContainer.style.display = 'block';
            } else {
                durationContainer.style.display = 'none';
            }

            const surfaceContainer = document.getElementById('modal-surface-container');
            if (realisation.surface) {
                document.getElementById('modalSurface').textContent = realisation.surface;
                surfaceContainer.style.display = 'block';
            } else {
                surfaceContainer.style.display = 'none';
            }

            const materialContainer = document.getElementById('modal-material-container');
            if (realisation.material) {
                document.getElementById('modalMaterial').textContent = realisation.material;
                materialContainer.style.display = 'block';
            } else {
                materialContainer.style.display = 'none';
            }

            const locationContainer = document.getElementById('modal-location-container');
            if (realisation.location) {
                document.getElementById('modalLocation').textContent = realisation.location;
                locationContainer.style.display = 'block';
            } else {
                locationContainer.style.display = 'none';
            }

            // Caract√©ristiques
            const featuresContainer = document.getElementById('modal-features-container');
            if (realisation.features && realisation.features.length > 0) {
                document.getElementById('modalFeatures').innerHTML = realisation.features
                    .map(f => `<li>${f.feature || f}</li>`)
                    .join('');
                featuresContainer.style.display = 'block';
            } else {
                featuresContainer.style.display = 'none';
            }

            // Galerie d'images suppl√©mentaires
            const galleryContainer = document.getElementById('modalGallery');
            if (realisation.gallery && realisation.gallery.length > 0) {
                galleryContainer.innerHTML = '<h3>Galerie</h3>' + 
                    realisation.gallery.map(img => `
                        <img src="${img.image || img}" alt="Galerie ${realisation.title}" class="gallery-img">
                    `).join('');
                galleryContainer.style.display = 'block';
            } else {
                galleryContainer.style.display = 'none';
            }

            // Afficher la modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Configurer la modal
        function setupModal() {
            const modal = document.getElementById('modal');
            const closeBtn = document.getElementById('modalClose');

            // Fermer avec le bouton X
            closeBtn.addEventListener('click', closeModal);

            // Fermer en cliquant en dehors
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Fermer avec la touche √âchap
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeModal();
                }
            });
        }

        // Fermer la modal
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Gestion Netlify Identity
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>

    <!-- Fallback si JS d√©sactiv√© -->
    <noscript>
        <div style="padding: 2rem; text-align: center; background: #f5f1e8;">
            <p>Activez JavaScript pour afficher les r√©alisations.</p>
        </div>
    </noscript>
</body>
</html>