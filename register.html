<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inscription ‚Äî Au Format</title>
  
  <link rel="stylesheet" href="/sources/css/style_global.css">
  <link rel="icon" href="/sources/img/logo_tmp.png" type="image/png">
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="/js/config.js"></script>
  <script defer src="/js/auth.js"></script>
  <script defer src="/js/include.js"></script>
  <link rel="stylesheet" href="/sources/css/style_global.css">
  <link rel="stylesheet" href="/sources/css/style_register.css">
  <link rel="stylesheet" href="/sources/css/style_header.css">
  <link rel="stylesheet" href="/sources/css/style_logout_modal.css">

  <link rel="icon" href="/sources/img/logo_tmp.png" type="image/png">
  <link rel="apple-touch-icon" href="/sources/img/logo_tmp.png">

 <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- IMPORTANT : include.js en PREMIER avec defer -->
  <script defer src="/js/include.js"></script>
  
  <!-- Ensuite les scripts d'auth -->
  <script defer src="/js/config.js"></script>
  <script defer src="/js/auth.js"></script>
  <script defer src="/js/activity-logger.js"></script>
  <script defer src="/js/logout-modal.js"></script>
  <script defer src="/js/header.js"></script>
  <script defer src="/js/header-auth.js"></script>
</head>


<body>

  <div class="auth-container">
    <!-- Partie visuelle gauche -->
    <div class="auth-visual">
      <div class="visual-content">
        <div class="visual-icon">üèóÔ∏è</div>
        <h1>Rejoignez<br>Au Format</h1>
        <p>Plus de 1000 clients nous font confiance pour leurs projets de menuiserie sur mesure. Cr√©ez votre compte en 30 secondes.</p>
        
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number">1000+</span>
            <span class="stat-label">Clients satisfaits</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">5000+</span>
            <span class="stat-label">Projets r√©alis√©s</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">4.9‚òÖ</span>
            <span class="stat-label">Note moyenne</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Partie formulaire droite -->
    <div class="auth-form-section">
      <div class="form-wrapper">
        <div class="form-header">
          <h2>Cr√©er un compte</h2>
          <p>Commencez votre projet d√®s maintenant</p>
        </div>

        <!-- Barre de progression -->
        <div class="form-progress">
          <div class="progress-step active"></div>
          <div class="progress-step"></div>
          <div class="progress-step"></div>
        </div>

        <!-- Alertes -->
        <div id="alert-success" class="alert alert-success"></div>
        <div id="alert-error" class="alert alert-error"></div>

        <!-- Formulaire -->
        <form id="register-form">
          <div class="form-group">
            <label class="form-label" for="email">Email *</label>
            <div class="input-wrapper">
              <input 
                type="email" 
                id="email" 
                class="form-input" 
                placeholder="votre@email.com"
                required
                autocomplete="email"
              >
              <span class="input-icon">üìß</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="password">Mot de passe *</label>
              <div class="input-wrapper">
                <input 
                  type="password" 
                  id="password" 
                  class="form-input" 
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required
                  minlength="6"
                  autocomplete="new-password"
                >
                <span class="input-icon">üîí</span>
                <button type="button" class="password-toggle-btn" onclick="togglePassword('password')">
                  <span id="toggle-icon-1">üëÅÔ∏è</span>
                </button>
              </div>
              <div class="password-strength" id="password-strength">
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
              </div>
              <div class="password-hint">Min. 6 caract√®res</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="password-confirm">Confirmer *</label>
              <div class="input-wrapper">
                <input 
                  type="password" 
                  id="password-confirm" 
                  class="form-input" 
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required
                  minlength="6"
                  autocomplete="new-password"
                >
                <span class="input-icon">üîê</span>
                <button type="button" class="password-toggle-btn" onclick="togglePassword('password-confirm')">
                  <span id="toggle-icon-2">üëÅÔ∏è</span>
                </button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="full-name">Nom complet *</label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="full-name" 
                class="form-input" 
                placeholder="Jean Dupont"
                required
                autocomplete="name"
              >
              <span class="input-icon">üë§</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="company-name">Entreprise (optionnel)</label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="company-name" 
                class="form-input" 
                placeholder="Nom de votre entreprise"
                autocomplete="organization"
              >
              <span class="input-icon">üè¢</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="phone">T√©l√©phone (optionnel)</label>
            <div class="input-wrapper">
              <input 
                type="tel" 
                id="phone" 
                class="form-input" 
                placeholder="06 12 34 56 78"
                autocomplete="tel"
              >
              <span class="input-icon">üì±</span>
            </div>
          </div>

          <div class="checkbox-wrapper">
            <input type="checkbox" id="terms" required>
            <label for="terms">
              J'accepte les <a href="/cgv.html" target="_blank">conditions g√©n√©rales</a> et la <a href="/privacy.html" target="_blank">politique de confidentialit√©</a>
            </label>
          </div>

          <button type="submit" class="btn-submit" id="submit-btn">
            <span>Cr√©er mon compte</span>
          </button>
        </form>

        <div class="auth-links">
          <p>Vous avez d√©j√† un compte ? <a href="/login.html">Se connecter</a></p>
        </div>
      </div>
    </div>
  </div>

<script>
  let currentStep = 1;

  // Gestion du formulaire d'inscription
  document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('password-confirm').value;
    const fullName = document.getElementById('full-name').value.trim();
    const companyName = document.getElementById('company-name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const termsAccepted = document.getElementById('terms').checked;
    const submitBtn = document.getElementById('submit-btn');

    // Validation
    if (password !== passwordConfirm) {
      showAlert('error', '‚ùå Les mots de passe ne correspondent pas');
      return;
    }

    if (!termsAccepted) {
      showAlert('error', '‚ùå Veuillez accepter les conditions g√©n√©rales');
      return;
    }

    // D√©sactiver le bouton
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Cr√©ation du compte...';
    updateProgress(2);

    // Masquer les alertes
    hideAlerts();

    // ‚úÖ MODIFICATION : Passer le t√©l√©phone √† la fonction register
    const result = await AuthSystem.register(email, password, fullName, companyName, phone);

    if (result.success) {
      updateProgress(3);
      showAlert('success', result.message);
      
      // ‚ùå SUPPRIMER ce bloc (le t√©l√©phone est d√©j√† dans les m√©tadonn√©es)
      // if (!result.requiresConfirmation && phone) {
      //   const user = result.user;
      //   await AuthSystem.updateProfile(user.id, { phone });
      // }
      
      // Redirection
      setTimeout(() => {
        if (result.requiresConfirmation) {
          window.location.href = '/login.html?message=confirm-email';
        } else {
          window.location.href = '/profile.html';
        }
      }, 2000);
    } else {
      showAlert('error', result.message);
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>Cr√©er mon compte</span>';
      updateProgress(1);
    }
  });

  // Indicateur de force du mot de passe
  document.getElementById('password').addEventListener('input', (e) => {
    const password = e.target.value;
    const bars = document.querySelectorAll('.strength-bar');
    const hint = document.querySelector('.password-hint');
    
    bars.forEach(bar => {
      bar.classList.remove('weak', 'medium', 'strong');
    });

    if (password.length === 0) {
      hint.textContent = 'Min. 6 caract√®res';
      return;
    }

    let strength = 0;
    if (password.length >= 6) strength++;
    if (password.length >= 10) strength++;
    if (/[A-Z]/.test(password) && /[a-z]/.test(password)) strength++;
    if (/[0-9]/.test(password) && /[^A-Za-z0-9]/.test(password)) strength++;

    if (strength <= 1) {
      bars[0].classList.add('weak');
      hint.textContent = '‚ùå Mot de passe faible';
      hint.style.color = '#ef4444';
    } else if (strength === 2) {
      bars[0].classList.add('medium');
      bars[1].classList.add('medium');
      hint.textContent = '‚ö†Ô∏è Mot de passe moyen';
      hint.style.color = '#f59e0b';
    } else if (strength === 3) {
      bars[0].classList.add('strong');
      bars[1].classList.add('strong');
      bars[2].classList.add('strong');
      hint.textContent = '‚úÖ Mot de passe correct';
      hint.style.color = '#10b981';
    } else {
      bars.forEach(bar => bar.classList.add('strong'));
      hint.textContent = '‚úÖ Mot de passe fort';
      hint.style.color = '#10b981';
    }
  });

  // Toggle mot de passe
  function togglePassword(inputId) {
    const passwordInput = document.getElementById(inputId);
    const iconId = inputId === 'password' ? 'toggle-icon-1' : 'toggle-icon-2';
    const toggleIcon = document.getElementById(iconId);
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      toggleIcon.textContent = 'üôà';
    } else {
      passwordInput.type = 'password';
      toggleIcon.textContent = 'üëÅÔ∏è';
    }
  }

  // Mise √† jour de la barre de progression
  function updateProgress(step) {
    currentStep = step;
    const steps = document.querySelectorAll('.progress-step');
    steps.forEach((el, index) => {
      if (index < step) {
        el.classList.add('active');
      } else {
        el.classList.remove('active');
      }
    });
  }

  // Afficher une alerte
  function showAlert(type, message) {
    const alertElement = document.getElementById(`alert-${type}`);
    alertElement.textContent = message;
    alertElement.style.display = 'block';
  }

  // Masquer les alertes
  function hideAlerts() {
    document.getElementById('alert-success').style.display = 'none';
    document.getElementById('alert-error').style.display = 'none';
  }

  // V√©rifier si d√©j√† connect√©
  (async () => {
    const user = await AUTH.getCurrentUser();
    if (user) {
      window.location.href = '/profile.html';
    }
  })();
</script>
</body>
</html>